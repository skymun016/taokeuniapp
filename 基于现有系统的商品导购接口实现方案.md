# 基于现有系统的商品导购接口实现方案

## 现有系统接口架构分析

### 1. 现有接口调用模式

**前端调用方式：**
```javascript
// 商品列表接口
this.$request.post('goods', that.where).then(res => {
    if (res.errno == 0) {
        that.goodsList = that.goodsList.concat(res.data.data);
    }
})

// 配置获取接口
this.$request.post('config/getInfo', {mo: 'common'}).then(res => {
    if (res.errno == 0) {
        // 处理配置数据
    }
})
```

**后端实现方式：**
```php
// 控制器方法直接对应接口名
class GoodsController extends Base {
    public function index() {  // 对应 'goods' 接口
        $weid = weid();
        $keyword = input('post.keyword', '', 'serach_in');
        // 业务逻辑...
        return $this->json(['errno' => 0, 'data' => $result]);
    }
}

// 配置管理
class ConfigController extends Base {
    public function getInfo() {  // 对应 'config/getInfo' 接口
        $mo = input('post.mo', '', 'serach_in');
        $res = Config::getconfig($mo);
        return $this->json(['data' => $res]);
    }
}
```

### 2. 数据处理模式

**参数获取：**
```php
$weid = weid();  // 获取站点ID
$keyword = input('post.keyword', '', 'serach_in');  // 获取POST参数
$page = input('post.page', 1, 'intval');  // 获取分页参数
```

**返回格式：**
```php
return $this->json(['errno' => 0, 'data' => $result]);  // 成功
return $this->json(['errno' => 1, 'message' => '错误信息']);  // 失败
```

## 商品导购接口扩展实现

### 1. 后端接口实现

#### 1.1 联盟配置管理控制器

```php
// app/admin/controller/ConfigController.php 扩展
class ConfigController extends Base
{
    // 现有方法保持不变...
    
    /**
     * 获取联盟配置 - 扩展现有getInfo方法
     */
    function getInfo()
    {
        $mo = input('post.mo', '', 'serach_in');
        if (empty($mo)) {
            $mo = 'common';
        }
        
        $res = Config::getconfig($mo);
        $res['mo'] = $mo;
        
        // 现有逻辑保持不变...
        
        // 新增：联盟配置处理
        if ($mo == 'union') {
            // 处理联盟配置数据
            if (!empty($res['taobao_config'])) {
                $res['taobao_config'] = json_decode($res['taobao_config'], true);
            }
            if (!empty($res['jd_config'])) {
                $res['jd_config'] = json_decode($res['jd_config'], true);
            }
        }
        
        return $this->json(['data' => $res]);
    }
    
    /**
     * 更新联盟配置 - 扩展现有update方法
     */
    public function update()
    {
        $config = $this->request->post();
        $mo = $config['mo'];
        if (empty($mo)) {
            $mo = 'common';
        }
        
        // 新增：联盟配置特殊处理
        if ($mo == 'union') {
            // 验证淘宝联盟配置
            if (!empty($config['taobao_app_key'])) {
                $taobaoConfig = [
                    'app_key' => $config['taobao_app_key'],
                    'app_secret' => $config['taobao_app_secret'],
                    'pid' => $config['taobao_pid'],
                    'status' => $config['taobao_status'] ?? 0
                ];
                $config['taobao_config'] = json_encode($taobaoConfig);
            }
            
            // 验证京东联盟配置
            if (!empty($config['jd_app_key'])) {
                $jdConfig = [
                    'app_key' => $config['jd_app_key'],
                    'app_secret' => $config['jd_app_secret'],
                    'site_id' => $config['jd_site_id'],
                    'status' => $config['jd_status'] ?? 0
                ];
                $config['jd_config'] = json_encode($jdConfig);
            }
        }
        
        // 现有更新逻辑保持不变
        $configstr = serialize($config);
        
        if (empty($config['id'])) {
            $data["weid"] = weid();
            $data["module"] = $mo;
            $data["status"] = 1;
            $data["settings"] = $configstr;
            Config::create($data);
        } else {
            Config::update(['settings' => $configstr], ['id' => $config['id']]);
        }
        
        return $this->json(['msg' => '操作成功']);
    }
    
    /**
     * 测试联盟API连接
     */
    public function testUnionApi()
    {
        $platform = input('post.platform', '');
        $config = input('post.');
        
        try {
            if ($platform == 'taobao') {
                $result = $this->testTaobaoApi($config);
            } elseif ($platform == 'jd') {
                $result = $this->testJdApi($config);
            } else {
                throw new \Exception('不支持的平台');
            }
            
            return $this->json(['msg' => 'API连接测试成功', 'data' => $result]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => 'API连接失败：' . $e->getMessage()]);
        }
    }
}
```

#### 1.2 联盟商品控制器

```php
// app/index/controller/UnionGoodsController.php
class UnionGoodsController extends Base
{
    /**
     * 联盟商品搜索 - 对应前端调用 'unionGoods'
     */
    public function index()
    {
        $weid = weid();
        $keyword = input('post.keyword', '', 'serach_in');
        $platform = input('post.platform', '', 'serach_in'); // taobao, jd, 或空
        $page = input('post.page', 1, 'intval');
        $limit = input('post.limit', 20, 'intval');
        
        if (empty($keyword)) {
            return $this->json(['errno' => 1, 'message' => '请输入搜索关键词']);
        }
        
        try {
            $result = [];
            $totalCount = 0;
            
            // 搜索淘宝商品
            if ($platform === 'taobao' || empty($platform)) {
                $taobaoGoods = $this->searchTaobaoGoods($keyword, $page, $limit, $weid);
                $result = array_merge($result, $taobaoGoods);
            }
            
            // 搜索京东商品
            if ($platform === 'jd' || empty($platform)) {
                $jdGoods = $this->searchJdGoods($keyword, $page, $limit, $weid);
                $result = array_merge($result, $jdGoods);
            }
            
            // 按现有系统格式返回数据
            $data = [
                'data' => $result,
                'total' => count($result),
                'page' => $page,
                'limit' => $limit
            ];
            
            return $this->json(['errno' => 0, 'data' => $data]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => $e->getMessage()]);
        }
    }
    
    /**
     * 获取购买链接 - 对应前端调用 'unionGoods/buylink'
     */
    public function buylink()
    {
        $platform = input('post.platform', '');
        $itemId = input('post.item_id', '');
        $weid = weid();
        
        if (empty($platform) || empty($itemId)) {
            return $this->json(['errno' => 1, 'message' => '参数错误']);
        }
        
        try {
            $buyUrl = '';
            
            if ($platform === 'taobao') {
                $buyUrl = $this->generateTaobaoBuyUrl($itemId, $weid);
            } elseif ($platform === 'jd') {
                $buyUrl = $this->generateJdBuyUrl($itemId, $weid);
            }
            
            return $this->json(['errno' => 0, 'data' => ['buy_url' => $buyUrl]]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => $e->getMessage()]);
        }
    }
    
    /**
     * 热门商品推荐 - 对应前端调用 'unionGoods/hot'
     */
    public function hot()
    {
        $weid = weid();
        $platform = input('post.platform', '');
        $limit = input('post.limit', 10, 'intval');
        
        try {
            // 获取热门关键词或固定推荐商品
            $hotKeywords = ['手机', '服装', '美妆', '家电', '食品'];
            $result = [];
            
            foreach ($hotKeywords as $keyword) {
                if ($platform === 'taobao' || empty($platform)) {
                    $goods = $this->searchTaobaoGoods($keyword, 1, 2, $weid);
                    $result = array_merge($result, array_slice($goods, 0, 2));
                }
                
                if (count($result) >= $limit) break;
            }
            
            return $this->json(['errno' => 0, 'data' => array_slice($result, 0, $limit)]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => $e->getMessage()]);
        }
    }
    
    /**
     * 搜索淘宝商品
     */
    private function searchTaobaoGoods($keyword, $page, $limit, $weid)
    {
        $config = Config::getconfig('union');
        if (empty($config['taobao_config'])) {
            return [];
        }
        
        $taobaoConfig = json_decode($config['taobao_config'], true);
        if (empty($taobaoConfig['status'])) {
            return [];
        }
        
        $params = [
            'method' => 'taobao.tbk.dg.material.optional',
            'app_key' => $taobaoConfig['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '2.0',
            'sign_method' => 'md5',
            'q' => $keyword,
            'adzone_id' => $taobaoConfig['pid'],
            'page_size' => $limit,
            'page_no' => $page,
            'platform' => 2,
            'has_coupon' => 'true'
        ];
        
        $params['sign'] = $this->generateTaobaoSign($params, $taobaoConfig['app_secret']);
        
        $response = $this->sendHttpRequest('https://eco.taobao.com/router/rest', $params);
        $result = json_decode($response, true);
        
        $goods = [];
        if (isset($result['tbk_dg_material_optional_response']['result_list']['map_data'])) {
            foreach ($result['tbk_dg_material_optional_response']['result_list']['map_data'] as $item) {
                $goods[] = [
                    'id' => 'tb_' . $item['num_iid'], // 添加前缀区分平台
                    'platform' => 'taobao',
                    'item_id' => $item['num_iid'],
                    'name' => $item['title'], // 统一字段名
                    'pic' => $item['pict_url'], // 统一字段名
                    'price' => $item['zk_final_price'],
                    'original_price' => $item['reserve_price'],
                    'commission_rate' => $item['commission_rate'],
                    'shop_title' => $item['shop_title'],
                    'volume' => $item['volume'],
                    'coupon_info' => $item['coupon_info'] ?? '',
                    'item_url' => $item['item_url']
                ];
            }
        }
        
        return $goods;
    }
    
    /**
     * 搜索京东商品
     */
    private function searchJdGoods($keyword, $page, $limit, $weid)
    {
        $config = Config::getconfig('union');
        if (empty($config['jd_config'])) {
            return [];
        }
        
        $jdConfig = json_decode($config['jd_config'], true);
        if (empty($jdConfig['status'])) {
            return [];
        }
        
        $params = [
            'method' => 'jd.union.open.goods.query',
            'app_key' => $jdConfig['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '1.0',
            'sign_method' => 'md5',
            'param_json' => json_encode([
                'goodsReq' => [
                    'keyword' => $keyword,
                    'pageIndex' => $page,
                    'pageSize' => $limit,
                    'hasCoupon' => 1
                ]
            ])
        ];
        
        $params['sign'] = $this->generateJdSign($params, $jdConfig['app_secret']);
        
        $response = $this->sendHttpRequest('https://api.jd.com/routerjson', $params);
        $result = json_decode($response, true);
        
        $goods = [];
        if (isset($result['jd_union_open_goods_query_response']['result']['data'])) {
            foreach ($result['jd_union_open_goods_query_response']['result']['data'] as $item) {
                $goods[] = [
                    'id' => 'jd_' . $item['skuId'], // 添加前缀区分平台
                    'platform' => 'jd',
                    'item_id' => $item['skuId'],
                    'name' => $item['skuName'], // 统一字段名
                    'pic' => $item['imageInfo']['imageList'][0]['url'] ?? '', // 统一字段名
                    'price' => $item['priceInfo']['lowestPrice'] ?? $item['priceInfo']['price'],
                    'original_price' => $item['priceInfo']['price'],
                    'commission_rate' => $item['commissionInfo']['commissionShare'],
                    'shop_title' => $item['shopInfo']['shopName'],
                    'volume' => $item['inOrderCount30Days'] ?? 0,
                    'coupon_info' => $item['couponInfo']['couponList'][0]['discount'] ?? '',
                    'item_url' => $item['materialUrl']
                ];
            }
        }
        
        return $goods;
    }
    
    // 其他辅助方法...
    private function generateTaobaoSign($params, $secret) { /* 签名算法 */ }
    private function generateJdSign($params, $secret) { /* 签名算法 */ }
    private function sendHttpRequest($url, $params) { /* HTTP请求 */ }
    private function generateTaobaoBuyUrl($itemId, $weid) { /* 生成淘宝购买链接 */ }
    private function generateJdBuyUrl($itemId, $weid) { /* 生成京东购买链接 */ }
}
```

### 2. 前端接口调用实现

#### 2.1 商品搜索页面

```vue
<!-- pages/union/index.vue -->
<template>
  <view class="union-page">
    <!-- 搜索框 -->
    <view class="search-box">
      <input v-model="searchForm.keyword" placeholder="搜索商品" @confirm="searchGoods" />
      <button @click="searchGoods">搜索</button>
    </view>
    
    <!-- 平台筛选 -->
    <view class="platform-tabs">
      <text :class="{active: searchForm.platform === ''}" @click="setPlatform('')">全部</text>
      <text :class="{active: searchForm.platform === 'taobao'}" @click="setPlatform('taobao')">淘宝</text>
      <text :class="{active: searchForm.platform === 'jd'}" @click="setPlatform('jd')">京东</text>
    </view>
    
    <!-- 商品列表 -->
    <view class="goods-list">
      <view v-for="item in goodsList" :key="item.id" class="goods-item">
        <image :src="item.pic" class="goods-image"></image>
        <view class="goods-info">
          <text class="goods-title">{{item.name}}</text>
          <view class="price-row">
            <text class="price">¥{{item.price}}</text>
            <text class="original-price" v-if="item.original_price > item.price">¥{{item.original_price}}</text>
          </view>
          <view class="shop-row">
            <text class="shop-name">{{item.shop_title}}</text>
            <text class="volume">月销{{item.volume}}</text>
          </view>
          <view class="coupon-row" v-if="item.coupon_info">
            <text class="coupon-tag">券</text>
            <text class="coupon-text">{{item.coupon_info}}</text>
          </view>
          <button class="buy-btn" @click="buyGoods(item)">立即购买</button>
        </view>
      </view>
    </view>
    
    <!-- 加载更多 -->
    <view class="load-more" v-if="hasMore && !loading">
      <text @click="loadMore">加载更多</text>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      searchForm: {
        keyword: '',
        platform: '',
        page: 1,
        limit: 20
      },
      goodsList: [],
      loading: false,
      hasMore: true
    }
  },
  onLoad() {
    this.loadHotGoods();
  },
  methods: {
    // 搜索商品 - 基于现有接口模式
    async searchGoods(isLoadMore = false) {
      if (!this.searchForm.keyword.trim()) {
        uni.showToast({title: '请输入搜索关键词', icon: 'none'});
        return;
      }
      
      if (this.loading) return;
      this.loading = true;
      
      if (!isLoadMore) {
        this.searchForm.page = 1;
        this.goodsList = [];
        this.hasMore = true;
      }
      
      try {
        // 按现有系统的调用方式
        const res = await this.$request.post('unionGoods', this.searchForm);
        
        if (res.errno === 0) {
          const newGoods = res.data.data || [];
          
          if (isLoadMore) {
            this.goodsList = this.goodsList.concat(newGoods);
          } else {
            this.goodsList = newGoods;
          }
          
          this.hasMore = newGoods.length >= this.searchForm.limit;
          this.searchForm.page++;
        } else {
          uni.showToast({title: res.message || '搜索失败', icon: 'none'});
        }
      } catch (error) {
        uni.showToast({title: '网络错误', icon: 'none'});
      } finally {
        this.loading = false;
      }
    },
    
    // 购买商品 - 核心功能
    async buyGoods(item) {
      try {
        uni.showLoading({title: '跳转中...'});
        
        // 获取购买链接
        const res = await this.$request.post('unionGoods/buylink', {
          platform: item.platform,
          item_id: item.item_id
        });
        
        if (res.errno === 0) {
          const buyUrl = res.data.buy_url;
          
          // 跳转处理
          // #ifdef MP-WEIXIN
          uni.navigateTo({
            url: `/pages/webview/index?url=${encodeURIComponent(buyUrl)}`
          });
          // #endif
          
          // #ifdef H5
          window.open(buyUrl);
          // #endif
          
          // #ifdef APP-PLUS
          plus.runtime.openURL(buyUrl);
          // #endif
        } else {
          uni.showToast({title: res.message || '获取购买链接失败', icon: 'none'});
        }
      } catch (error) {
        uni.showToast({title: '跳转失败', icon: 'none'});
      } finally {
        uni.hideLoading();
      }
    },
    
    // 加载热门商品
    async loadHotGoods() {
      try {
        const res = await this.$request.post('unionGoods/hot', {
          platform: '',
          limit: 10
        });
        
        if (res.errno === 0) {
          this.goodsList = res.data;
        }
      } catch (error) {
        console.error('加载热门商品失败:', error);
      }
    },
    
    // 设置平台筛选
    setPlatform(platform) {
      this.searchForm.platform = platform;
      if (this.searchForm.keyword) {
        this.searchGoods();
      }
    },
    
    // 加载更多
    loadMore() {
      if (this.searchForm.keyword) {
        this.searchGoods(true);
      }
    }
  }
}
</script>
```

#### 2.2 WebView页面（处理外部跳转）

```vue
<!-- pages/webview/index.vue -->
<template>
  <web-view :src="url" @message="handleMessage"></web-view>
</template>

<script>
export default {
  data() {
    return {
      url: ''
    }
  },
  onLoad(options) {
    this.url = decodeURIComponent(options.url || '');
    
    // 设置页面标题
    uni.setNavigationBarTitle({
      title: '商品购买'
    });
  },
  methods: {
    handleMessage(event) {
      // 处理web-view消息
      console.log('WebView消息:', event);
    }
  }
}
</script>
```

### 3. 路由配置

```json
// pages.json 添加页面配置
{
  "pages": [
    // 现有页面...
    {
      "path": "pages/union/index",
      "style": {
        "navigationBarTitleText": "商品导购",
        "enablePullDownRefresh": true,
        "onReachBottomDistance": 50
      }
    },
    {
      "path": "pages/webview/index", 
      "style": {
        "navigationBarTitleText": "商品购买"
      }
    }
  ]
}
```

## 接口对比总结

### 现有系统 vs 新增功能

| 功能 | 现有接口 | 新增联盟接口 | 调用方式 |
|------|----------|-------------|----------|
| 商品列表 | `goods` | `unionGoods` | `this.$request.post('unionGoods', params)` |
| 商品详情 | `goods/detail` | `unionGoods/buylink` | `this.$request.post('unionGoods/buylink', params)` |
| 热门推荐 | `goods/recommend` | `unionGoods/hot` | `this.$request.post('unionGoods/hot', params)` |
| 配置管理 | `config/getInfo` | `config/getInfo` (扩展) | `this.$request.post('config/getInfo', {mo: 'union'})` |

### 关键实现要点

1. **完全基于现有架构**：新接口遵循现有的命名和调用规范
2. **数据格式统一**：返回格式与现有接口保持一致
3. **配置管理复用**：扩展现有Config系统，无需新建表
4. **前端调用一致**：使用相同的`$request.post()`调用方式
5. **错误处理统一**：使用相同的`errno`错误码体系

这样的实现方案可以无缝集成到现有系统中，开发和维护成本最低。