# 淘宝客&京东联盟API集成指南

## 概述

本指南将帮助你将淘宝客和京东联盟API功能集成到新麦同城上门服务系统中，实现商品推广和佣金收益功能。

## 系统要求

- PHP 7.2+
- MySQL 5.7+
- ThinkPHP 6.x
- uni-app框架
- curl扩展支持

## 安装步骤

### 1. 数据库初始化

执行SQL文件创建必要的数据表：

```sql
-- 执行 union_api_tables.sql 文件
mysql -u用户名 -p密码 数据库名 < union_api_tables.sql
```

### 2. 后端文件部署

将以下文件复制到对应目录：

```
上门服务代码安装包/服务器代码/app/model/
├── UnionConfig.php          # API配置模型
├── UnionGoods.php          # 联盟商品模型
└── UnionCategory.php       # 联盟分类模型

上门服务代码安装包/服务器代码/app/index/controller/
└── UnionController.php     # 前端API控制器

上门服务代码安装包/服务器代码/app/admin/controller/
└── UnionConfigController.php # 后台管理控制器
```

### 3. 前端页面部署

将以下文件复制到uni-app项目：

```
xm-mallv3-uni-master/pages/union/
├── list.vue               # 商品列表页
└── detail.vue            # 商品详情页
```

更新 `pages.json` 文件，添加页面路由配置。

## API申请指南

### 淘宝客API申请

1. 访问 [淘宝开放平台](https://open.taobao.com/)
2. 注册开发者账号并实名认证
3. 创建应用，选择"淘宝客API"
4. 获取APP KEY和APP SECRET
5. 在[淘宝联盟](https://pub.alimama.com/)创建推广位获取PID

**所需参数：**
- APP KEY: 应用标识
- APP SECRET: 应用密钥
- PID: 推广位ID，格式：mm_xxx_xxx_xxx
- SESSION KEY: 用户授权密钥（可选）

### 京东联盟API申请

1. 访问 [京东开放平台](https://open.jd.com/)
2. 注册开发者账号并完成企业认证
3. 申请京东联盟API权限
4. 获取APP KEY和APP SECRET
5. 在京东联盟后台获取网站ID

**所需参数：**
- APP KEY: 应用标识
- APP SECRET: 应用密钥
- 网站ID: 推广网站ID
- 广告位ID: 推广广告位ID（可选）

## 配置说明

### 1. 后台配置

登录系统后台，进入"联盟配置管理"：

1. 点击"添加配置"
2. 选择平台类型（淘宝/京东）
3. 填写API参数
4. 点击"测试连接"验证配置
5. 启用配置

### 2. 分类同步

在配置管理页面：

1. 选择已配置的平台
2. 点击"同步分类"
3. 系统将自动同步商品分类数据

### 3. 商品同步

商品数据采用实时同步策略：

- 用户搜索时自动从API获取最新数据
- 本地缓存商品信息提高访问速度
- 定期清理过期商品数据

## 功能特性

### 已实现功能

- ✅ 淘宝客API配置管理
- ✅ 京东联盟API配置管理
- ✅ API连接测试
- ✅ 商品搜索和展示
- ✅ 商品分类管理
- ✅ 推广链接生成
- ✅ 佣金计算显示
- ✅ 优惠券信息展示
- ✅ 移动端适配

### 核心接口

**前端API接口：**
- `GET /union/goodsList` - 获取商品列表
- `GET /union/goodsDetail` - 获取商品详情
- `GET /union/searchGoods` - 搜索商品
- `GET /union/categoryList` - 获取分类列表
- `GET /union/hotGoods` - 获取热门商品
- `GET /union/couponGoods` - 获取优惠券商品
- `POST /union/generatePromotion` - 生成推广链接

**后台管理接口：**
- `GET /admin/unionConfig/index` - 配置列表
- `POST /admin/unionConfig/add` - 添加配置
- `POST /admin/unionConfig/edit` - 编辑配置
- `POST /admin/unionConfig/delete` - 删除配置
- `POST /admin/unionConfig/testConnection` - 测试连接
- `POST /admin/unionConfig/syncCategories` - 同步分类

## 使用说明

### 前端使用

1. **商品列表页面**
   ```javascript
   // 跳转到联盟商品列表
   uni.navigateTo({
       url: '/pages/union/list'
   });
   ```

2. **商品搜索**
   ```javascript
   // 搜索商品
   this.$request.get('union/searchGoods', {
       keyword: '手机',
       platform: 'taobao',
       page: 1,
       limit: 20
   });
   ```

3. **生成推广链接**
   ```javascript
   // 生成推广链接
   this.$request.post('union/generatePromotion', {
       goods_id: 123
   });
   ```

### 后端扩展

1. **自定义商品同步逻辑**
   ```php
   // 在UnionController中扩展同步方法
   private function customSyncGoods($keyword, $config) {
       // 自定义同步逻辑
   }
   ```

2. **添加新的联盟平台**
   ```php
   // 在UnionConfig模型中添加新平台支持
   public static function getNewPlatformDefaultConfig() {
       return [
           'app_key' => '',
           'app_secret' => '',
           // 其他配置参数
       ];
   }
   ```

## 数据库表结构

### 主要数据表

1. **ims_xm_mallv3_union_config** - API配置表
2. **ims_xm_mallv3_union_goods** - 联盟商品表
3. **ims_xm_mallv3_union_category** - 联盟分类表
4. **ims_xm_mallv3_union_promotion** - 推广链接记录表
5. **ims_xm_mallv3_union_sync_log** - 同步日志表

### 索引优化

```sql
-- 商品表索引
ALTER TABLE `ims_xm_mallv3_union_goods` ADD INDEX `idx_platform_category` (`platform`, `category_id`);
ALTER TABLE `ims_xm_mallv3_union_goods` ADD INDEX `idx_sync_time` (`sync_time`);

-- 分类表索引
ALTER TABLE `ims_xm_mallv3_union_category` ADD INDEX `idx_platform_pid` (`platform`, `pid`);
```

## 性能优化

### 缓存策略

1. **API配置缓存**
   - 缓存时间：1小时
   - 自动清理：配置更新时

2. **商品数据缓存**
   - 本地数据库缓存
   - 定期清理过期数据

3. **分类数据缓存**
   - 长期缓存
   - 手动同步更新

### 请求优化

1. **批量处理**
   - 商品数据批量保存
   - 分类数据批量同步

2. **异步处理**
   - 大量数据同步使用队列
   - 避免接口超时

## 错误处理

### 常见错误及解决方案

1. **API连接失败**
   - 检查网络连接
   - 验证API参数
   - 确认API权限

2. **签名验证失败**
   - 检查APP SECRET
   - 确认参数格式
   - 验证时间戳

3. **商品同步失败**
   - 检查API配置
   - 验证请求参数
   - 查看错误日志

## 安全注意事项

1. **API密钥保护**
   - 不要在前端暴露APP SECRET
   - 定期更换API密钥
   - 使用HTTPS传输

2. **数据验证**
   - 验证所有输入参数
   - 过滤恶意数据
   - 防止SQL注入

3. **访问控制**
   - 限制API调用频率
   - 验证用户权限
   - 记录操作日志

## 版本更新记录

- **v1.0.0** (2024-01-15)
  - 初始版本发布
  - 支持淘宝客和京东联盟API配置
  - 完整的前后端功能实现
  - 商品搜索和推广功能

## 技术支持

如遇到问题，请检查：

1. 系统环境是否满足要求
2. API配置是否正确
3. 数据库表是否创建成功
4. 文件权限是否正确

## 扩展开发

### 添加新功能

1. **商品收藏功能**
2. **推广数据统计**
3. **佣金结算管理**
4. **多级分销体系**

### 集成其他平台

1. **拼多多联盟**
2. **苏宁联盟**
3. **唯品会联盟**

通过本指南，你可以成功将淘宝客和京东联盟功能集成到新麦同城系统中，为用户提供丰富的商品选择和推广收益机会。