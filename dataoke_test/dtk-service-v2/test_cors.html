<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORSè·¨åŸŸæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #e41f19; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #c41e3a; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; white-space: pre-wrap; font-family: monospace; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .loading { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸŒ CORSè·¨åŸŸæµ‹è¯•</h1>
            <p>æµ‹è¯•å¤§æ·˜å®¢APIçš„è·¨åŸŸé…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="card">
            <h2>åŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button class="btn" onclick="testConnection()">æµ‹è¯•APIè¿æ¥</button>
            <button class="btn" onclick="testCors()">æµ‹è¯•CORSé¢„æ£€</button>
            <button class="btn" onclick="testStats()">æµ‹è¯•ç»Ÿè®¡æ¥å£</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>å•†å“æ¥å£æµ‹è¯•</h2>
            <button class="btn" onclick="testGoodsList()">æµ‹è¯•å•†å“åˆ—è¡¨</button>
            <button class="btn" onclick="testHotGoods()">æµ‹è¯•çƒ­é—¨å•†å“</button>
            <button class="btn" onclick="testCouponGoods()">æµ‹è¯•ä¼˜æƒ åˆ¸å•†å“</button>
            <div id="goodsResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>è½¬é“¾æ¥å£æµ‹è¯•</h2>
            <input type="text" id="goodsIdInput" placeholder="è¾“å…¥å•†å“ID" style="padding: 8px; margin-right: 10px; width: 200px;">
            <button class="btn" onclick="testConvertLink()">æµ‹è¯•è½¬é“¾</button>
            <div id="linkResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>é”™è¯¯å¤„ç†æµ‹è¯•</h2>
            <button class="btn" onclick="test404()">æµ‹è¯•404é”™è¯¯</button>
            <button class="btn" onclick="test405()">æµ‹è¯•405é”™è¯¯</button>
            <div id="errorResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://dtkv2.zhishujiaoyu.com/dtk-service-v2/api/';

        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.textContent = content;
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result loading';
            element.textContent = 'æµ‹è¯•ä¸­...';
        }

        async function testConnection() {
            showLoading('connectionResult');
            try {
                const response = await fetch(API_BASE + 'test.php');
                const data = await response.json();
                showResult('connectionResult', `âœ… è¿æ¥æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('connectionResult', `âŒ è¿æ¥å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testCors() {
            showLoading('connectionResult');
            try {
                // å‘é€OPTIONSé¢„æ£€è¯·æ±‚
                const response = await fetch(API_BASE + 'test.php', {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                showResult('connectionResult', `âœ… CORSé¢„æ£€æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\nCORSå¤´éƒ¨: ${JSON.stringify(corsHeaders, null, 2)}`);
            } catch (error) {
                showResult('connectionResult', `âŒ CORSé¢„æ£€å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testStats() {
            showLoading('connectionResult');
            try {
                const response = await fetch(API_BASE + 'sync.php?type=stats&platform=taobao');
                const data = await response.json();
                showResult('connectionResult', `âœ… ç»Ÿè®¡æ¥å£æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\næ•°æ®: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('connectionResult', `âŒ ç»Ÿè®¡æ¥å£å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testGoodsList() {
            showLoading('goodsResult');
            try {
                const response = await fetch(API_BASE + 'goods.php?page=1&limit=5');
                const data = await response.json();
                showResult('goodsResult', `âœ… å•†å“åˆ—è¡¨æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\nå•†å“æ•°é‡: ${data.data?.list?.length || 0}\næ•°æ®: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('goodsResult', `âŒ å•†å“åˆ—è¡¨å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testHotGoods() {
            showLoading('goodsResult');
            try {
                const response = await fetch(API_BASE + 'goods.php?tier_level=1&link_status=1&limit=3');
                const data = await response.json();
                showResult('goodsResult', `âœ… çƒ­é—¨å•†å“æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\nå•†å“æ•°é‡: ${data.data?.list?.length || 0}\næ•°æ®: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('goodsResult', `âŒ çƒ­é—¨å•†å“å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testCouponGoods() {
            showLoading('goodsResult');
            try {
                const response = await fetch(API_BASE + 'goods.php?filter=coupon&limit=3');
                const data = await response.json();
                showResult('goodsResult', `âœ… ä¼˜æƒ åˆ¸å•†å“æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\nå•†å“æ•°é‡: ${data.data?.list?.length || 0}\næ•°æ®: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('goodsResult', `âŒ ä¼˜æƒ åˆ¸å•†å“å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function testConvertLink() {
            const goodsId = document.getElementById('goodsIdInput').value;
            if (!goodsId) {
                showResult('linkResult', 'âŒ è¯·è¾“å…¥å•†å“ID', true);
                return;
            }

            showLoading('linkResult');
            try {
                const response = await fetch(API_BASE + 'link.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        goods_id: goodsId,
                        platform: 'taobao'
                    })
                });
                const data = await response.json();
                showResult('linkResult', `âœ… è½¬é“¾æµ‹è¯•æˆåŠŸ\nçŠ¶æ€ç : ${response.status}\næ•°æ®: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('linkResult', `âŒ è½¬é“¾æµ‹è¯•å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function test404() {
            showLoading('errorResult');
            try {
                const response = await fetch(API_BASE + 'nonexistent.php');
                const data = await response.json();
                showResult('errorResult', `404é”™è¯¯å¤„ç†\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('errorResult', `âŒ 404æµ‹è¯•å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        async function test405() {
            showLoading('errorResult');
            try {
                const response = await fetch(API_BASE + 'goods.php', {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult('errorResult', `405é”™è¯¯å¤„ç†\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('errorResult', `âŒ 405æµ‹è¯•å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>
