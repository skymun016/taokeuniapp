# 淘宝联盟&京东联盟商品导购平台开发方案

## 需求重新定义

### 核心业务模式
**商品导购平台**：用户在小程序中浏览商品 → 点击购买跳转到淘宝/京东 → 用户完成购买 → 平台获得推广佣金

### 核心功能
1. **后端配置管理**：配置淘宝联盟和京东联盟API信息
2. **商品数据获取**：从联盟API获取商品信息并展示
3. **前端商品展示**：小程序端展示商品列表和详情
4. **购买跳转**：用户点击购买时跳转到对应平台（携带推广参数）
5. **佣金自动获取**：用户购买后平台自动获得佣金（无需用户操作）

## 业务流程图

```
用户打开小程序
    ↓
浏览商品列表（从联盟API获取）
    ↓
点击商品查看详情
    ↓
点击"立即购买"按钮
    ↓
跳转到淘宝/京东APP（携带平台推广ID）
    ↓
用户在淘宝/京东完成购买
    ↓
平台自动获得推广佣金
```

## 技术实现方案

### 1. 数据库设计（简化版）

```sql
-- API配置表
CREATE TABLE `ims_xm_mallv3_union_config` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `weid` int(11) NOT NULL DEFAULT '0',
  `platform` varchar(20) NOT NULL COMMENT '平台：taobao,jd',
  `app_key` varchar(100) DEFAULT '',
  `app_secret` varchar(100) DEFAULT '',
  `pid` varchar(50) DEFAULT '' COMMENT '推广位ID',
  `status` tinyint(1) DEFAULT '0',
  `settings` text,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 商品缓存表（可选，用于提高性能）
CREATE TABLE `ims_xm_mallv3_union_goods_cache` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `weid` int(11) NOT NULL DEFAULT '0',
  `platform` varchar(20) NOT NULL,
  `keyword` varchar(100) NOT NULL COMMENT '搜索关键词',
  `goods_data` longtext COMMENT '商品数据JSON',
  `expire_time` int(11) DEFAULT '0' COMMENT '过期时间',
  PRIMARY KEY (`id`),
  KEY `keyword_platform` (`keyword`, `platform`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 2. 后端API控制器（核心实现）

```php
// app/index/controller/UnionController.php
class UnionController extends Base
{
    /**
     * 搜索商品 - 对应前端调用 union
     */
    public function index()
    {
        $weid = weid();
        $keyword = input('keyword', '');
        $platform = input('platform', ''); // taobao, jd, 或空（全部）
        $page = input('page', 1, 'intval');
        
        if (empty($keyword)) {
            return $this->json(['errno' => 1, 'message' => '请输入搜索关键词']);
        }
        
        try {
            $result = [];
            
            // 搜索淘宝商品
            if ($platform === 'taobao' || empty($platform)) {
                $taobaoGoods = $this->searchTaobaoGoods($keyword, $page, $weid);
                $result = array_merge($result, $taobaoGoods);
            }
            
            // 搜索京东商品
            if ($platform === 'jd' || empty($platform)) {
                $jdGoods = $this->searchJdGoods($keyword, $page, $weid);
                $result = array_merge($result, $jdGoods);
            }
            
            return $this->json(['errno' => 0, 'data' => $result]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => $e->getMessage()]);
        }
    }
    
    /**
     * 获取购买链接（重点：生成带推广参数的链接）
     */
    public function buylink()
    {
        $platform = input('platform', '');
        $itemId = input('item_id', '');
        $weid = weid();
        
        if (empty($platform) || empty($itemId)) {
            return $this->json(['errno' => 1, 'message' => '参数错误']);
        }
        
        try {
            $buyUrl = '';
            
            if ($platform === 'taobao') {
                $buyUrl = $this->generateTaobaoBuyUrl($itemId, $weid);
            } elseif ($platform === 'jd') {
                $buyUrl = $this->generateJdBuyUrl($itemId, $weid);
            }
            
            return $this->json(['errno' => 0, 'data' => ['buy_url' => $buyUrl]]);
        } catch (\Exception $e) {
            return $this->json(['errno' => 1, 'message' => $e->getMessage()]);
        }
    }
    
    /**
     * 搜索淘宝商品
     */
    private function searchTaobaoGoods($keyword, $page, $weid)
    {
        $config = $this->getUnionConfig('taobao', $weid);
        if (!$config) {
            return [];
        }
        
        $params = [
            'method' => 'taobao.tbk.dg.material.optional',
            'app_key' => $config['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '2.0',
            'sign_method' => 'md5',
            'q' => $keyword,
            'adzone_id' => $config['pid'],
            'page_size' => 20,
            'page_no' => $page,
            'platform' => 2, // 无线端
            'has_coupon' => 'true'
        ];
        
        $params['sign'] = $this->generateTaobaoSign($params, $config['app_secret']);
        
        $response = $this->sendHttpRequest('https://eco.taobao.com/router/rest', $params);
        $result = json_decode($response, true);
        
        $goods = [];
        if (isset($result['tbk_dg_material_optional_response']['result_list']['map_data'])) {
            foreach ($result['tbk_dg_material_optional_response']['result_list']['map_data'] as $item) {
                $goods[] = [
                    'platform' => 'taobao',
                    'item_id' => $item['num_iid'],
                    'title' => $item['title'],
                    'pic_url' => $item['pict_url'],
                    'price' => $item['zk_final_price'],
                    'original_price' => $item['reserve_price'],
                    'commission_rate' => $item['commission_rate'],
                    'shop_title' => $item['shop_title'],
                    'volume' => $item['volume'],
                    'coupon_info' => $item['coupon_info'] ?? '',
                    'item_url' => $item['item_url'] // 原始商品链接
                ];
            }
        }
        
        return $goods;
    }
    
    /**
     * 搜索京东商品
     */
    private function searchJdGoods($keyword, $page, $weid)
    {
        $config = $this->getUnionConfig('jd', $weid);
        if (!$config) {
            return [];
        }
        
        $params = [
            'method' => 'jd.union.open.goods.query',
            'app_key' => $config['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '1.0',
            'sign_method' => 'md5',
            'param_json' => json_encode([
                'goodsReq' => [
                    'keyword' => $keyword,
                    'pageIndex' => $page,
                    'pageSize' => 20,
                    'hasCoupon' => 1
                ]
            ])
        ];
        
        $params['sign'] = $this->generateJdSign($params, $config['app_secret']);
        
        $response = $this->sendHttpRequest('https://api.jd.com/routerjson', $params);
        $result = json_decode($response, true);
        
        $goods = [];
        if (isset($result['jd_union_open_goods_query_response']['result']['data'])) {
            foreach ($result['jd_union_open_goods_query_response']['result']['data'] as $item) {
                $goods[] = [
                    'platform' => 'jd',
                    'item_id' => $item['skuId'],
                    'title' => $item['skuName'],
                    'pic_url' => $item['imageInfo']['imageList'][0]['url'] ?? '',
                    'price' => $item['priceInfo']['lowestPrice'] ?? $item['priceInfo']['price'],
                    'original_price' => $item['priceInfo']['price'],
                    'commission_rate' => $item['commissionInfo']['commissionShare'],
                    'shop_title' => $item['shopInfo']['shopName'],
                    'volume' => $item['inOrderCount30Days'] ?? 0,
                    'coupon_info' => $item['couponInfo']['couponList'][0]['discount'] ?? '',
                    'item_url' => $item['materialUrl'] // 原始商品链接
                ];
            }
        }
        
        return $goods;
    }
    
    /**
     * 生成淘宝购买链接（关键：带推广参数）
     */
    private function generateTaobaoBuyUrl($itemId, $weid)
    {
        $config = $this->getUnionConfig('taobao', $weid);
        
        // 方案1：直接使用推广位参数构造链接
        $buyUrl = "https://item.taobao.com/item.htm?id={$itemId}&pid={$config['pid']}";
        
        // 方案2：调用淘宝客转链API（推荐）
        $params = [
            'method' => 'taobao.tbk.item.convert',
            'app_key' => $config['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '2.0',
            'sign_method' => 'md5',
            'num_iids' => $itemId,
            'adzone_id' => $config['pid'],
            'platform' => 2
        ];
        
        $params['sign'] = $this->generateTaobaoSign($params, $config['app_secret']);
        
        $response = $this->sendHttpRequest('https://eco.taobao.com/router/rest', $params);
        $result = json_decode($response, true);
        
        if (isset($result['tbk_item_convert_response']['results']['n_tbk_item'][0]['click_url'])) {
            $buyUrl = $result['tbk_item_convert_response']['results']['n_tbk_item'][0]['click_url'];
        }
        
        return $buyUrl;
    }
    
    /**
     * 生成京东购买链接（关键：带推广参数）
     */
    private function generateJdBuyUrl($itemId, $weid)
    {
        $config = $this->getUnionConfig('jd', $weid);
        
        $params = [
            'method' => 'jd.union.open.promotion.common.get',
            'app_key' => $config['app_key'],
            'timestamp' => date('Y-m-d H:i:s'),
            'format' => 'json',
            'v' => '1.0',
            'sign_method' => 'md5',
            'param_json' => json_encode([
                'promotionCodeReq' => [
                    'materialId' => $itemId,
                    'siteId' => $config['pid']
                ]
            ])
        ];
        
        $params['sign'] = $this->generateJdSign($params, $config['app_secret']);
        
        $response = $this->sendHttpRequest('https://api.jd.com/routerjson', $params);
        $result = json_decode($response, true);
        
        $buyUrl = "https://item.jd.com/{$itemId}.html";
        if (isset($result['jd_union_open_promotion_common_get_response']['result']['data']['shortURL'])) {
            $buyUrl = $result['jd_union_open_promotion_common_get_response']['result']['data']['shortURL'];
        }
        
        return $buyUrl;
    }
}
```

### 3. 前端实现（简化版）

```vue
<!-- pages/union/index.vue -->
<template>
  <view class="union-page">
    <!-- 搜索框 -->
    <view class="search-box">
      <input v-model="keyword" placeholder="搜索商品" @confirm="searchGoods" />
      <button @click="searchGoods">搜索</button>
    </view>
    
    <!-- 平台筛选 -->
    <view class="platform-filter">
      <text :class="{active: platform === ''}" @click="setPlatform('')">全部</text>
      <text :class="{active: platform === 'taobao'}" @click="setPlatform('taobao')">淘宝</text>
      <text :class="{active: platform === 'jd'}" @click="setPlatform('jd')">京东</text>
    </view>
    
    <!-- 商品列表 -->
    <view class="goods-list">
      <view v-for="item in goodsList" :key="item.item_id" class="goods-item">
        <image :src="item.pic_url" class="goods-image"></image>
        <view class="goods-info">
          <text class="goods-title">{{item.title}}</text>
          <view class="price-row">
            <text class="price">¥{{item.price}}</text>
            <text class="original-price">¥{{item.original_price}}</text>
          </view>
          <text class="shop-info">{{item.shop_title}} | 月销{{item.volume}}</text>
          <!-- 关键：购买按钮 -->
          <button class="buy-btn" @click="buyGoods(item)">立即购买</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      keyword: '',
      platform: '',
      goodsList: []
    }
  },
  methods: {
    // 搜索商品
    async searchGoods() {
      if (!this.keyword.trim()) {
        uni.showToast({title: '请输入搜索关键词', icon: 'none'});
        return;
      }
      
      try {
        const res = await this.$request.post('union', {
          keyword: this.keyword,
          platform: this.platform,
          page: 1
        });
        
        if (res.errno === 0) {
          this.goodsList = res.data;
        }
      } catch (error) {
        uni.showToast({title: '搜索失败', icon: 'none'});
      }
    },
    
    // 购买商品（核心功能）
    async buyGoods(item) {
      try {
        uni.showLoading({title: '跳转中...'});
        
        // 获取带推广参数的购买链接
        const res = await this.$request.post('union/buylink', {
          platform: item.platform,
          item_id: item.item_id
        });
        
        if (res.errno === 0) {
          const buyUrl = res.data.buy_url;
          
          // 跳转到外部链接（淘宝/京东）
          // #ifdef MP-WEIXIN
          // 小程序中需要配置业务域名或使用web-view
          uni.navigateTo({
            url: `/pages/webview/index?url=${encodeURIComponent(buyUrl)}`
          });
          // #endif
          
          // #ifdef H5
          window.open(buyUrl);
          // #endif
          
          // #ifdef APP-PLUS
          plus.runtime.openURL(buyUrl);
          // #endif
        }
      } catch (error) {
        uni.showToast({title: '跳转失败', icon: 'none'});
      } finally {
        uni.hideLoading();
      }
    },
    
    setPlatform(platform) {
      this.platform = platform;
      if (this.keyword) {
        this.searchGoods();
      }
    }
  }
}
</script>
```

### 4. WebView页面（用于小程序跳转）

```vue
<!-- pages/webview/index.vue -->
<template>
  <web-view :src="url"></web-view>
</template>

<script>
export default {
  data() {
    return {
      url: ''
    }
  },
  onLoad(options) {
    this.url = decodeURIComponent(options.url);
  }
}
</script>
```

## 关键技术点

### 1. 推广链接生成
- **淘宝**：使用`taobao.tbk.item.convert` API生成推广链接
- **京东**：使用`jd.union.open.promotion.common.get` API生成推广链接
- 链接中包含平台的推广位ID，用户购买后平台自动获得佣金

### 2. 小程序跳转处理
- 使用`web-view`组件承载外部链接
- 需要在小程序后台配置业务域名
- 或者引导用户复制链接到对应APP

### 3. 佣金结算
- 佣金由淘宝联盟/京东联盟自动结算
- 平台可在联盟后台查看收益数据
- 无需额外开发结算功能

## 开发优先级

### 第一阶段（核心功能）
1. 后台API配置管理
2. 商品搜索接口开发
3. 购买链接生成接口
4. 前端商品展示页面

### 第二阶段（优化功能）
1. 商品数据缓存
2. 分类筛选功能
3. 收藏和历史记录
4. 数据统计分析

### 第三阶段（增值功能）
1. 个性化推荐
2. 优惠券聚合
3. 价格监控
4. 社交分享

## 收益模式

1. **佣金收入**：用户通过平台购买商品，平台获得3%-10%的推广佣金
2. **流量变现**：积累用户后可接入其他广告或服务
3. **增值服务**：提供VIP会员、专属优惠等付费服务

这个方案专注于**商品导购**而非**用户推广**，更符合你的实际需求，实现起来也更简单直接。